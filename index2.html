<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Object Detection with Custom Model</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        video, canvas {
            display: block;
            margin: 0 auto;
        }
    </style>
</head>
<body>

    <h1>Real-time Object Detection</h1>
    <video id="webcam" autoplay playsinline width="640" height="480"></video>
    <canvas id="output" width="640" height="480"></canvas>

    <script type="text/javascript">
        // Fungsi untuk memuat webcam
        async function setupWebcam() {
            const webcamElement = document.getElementById('webcam');
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({
                    video: true
                }).then(stream => {
                    webcamElement.srcObject = stream;
                    webcamElement.addEventListener('loadeddata', () => resolve(webcamElement));
                }).catch(reject);
            });
        }

        // Fungsi untuk memuat model TensorFlow JS custom
        async function loadModel() {
            const model = await tf.loadGraphModel('tf_JS/model.json'); // Memuat model dari folder tf_JS
            return model;
        }

        async function detectObjects() {
            const video = await setupWebcam();
            const model = await loadModel();
            const canvas = document.getElementById('output');
            const ctx = canvas.getContext('2d');

            video.width = video.videoWidth;
            video.height = video.videoHeight;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Fungsi untuk mendeteksi objek pada tiap frame
            async function detectFrame() {
                const imgTensor = tf.browser.fromPixels(video); // Konversi video menjadi tensor
                const predictions = await model.executeAsync(imgTensor.expandDims(0));

                // Logging untuk memeriksa keluaran prediksi
                console.log(predictions);

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Periksa apakah prediksi berupa tensor, array atau object
                const boxes = predictions[0].arraySync();  // Misal: mengambil bounding box dari prediksi
                const scores = predictions[1].arraySync(); // Misal: mengambil skor dari prediksi
                const classes = predictions[2].arraySync(); // Misal: mengambil kelas dari prediksi

                console.log('Boxes:', boxes);
                console.log('Scores:', scores);
                console.log('Classes:', classes);

                for (let i = 0; i < boxes.length; i++) {
                    if (scores[i] > 0.1) { // Tampilkan hanya yang skornya lebih dari 50%
                        const [y, x, height, width] = boxes[i];
                        ctx.beginPath();
                        ctx.rect(x * video.videoWidth, y * video.videoHeight, width * video.videoWidth, height * video.videoHeight);
                        ctx.lineWidth = 2;
                        ctx.strokeStyle = 'green';
                        ctx.fillStyle = 'green';
                        ctx.stroke();
                        ctx.fillText(
                            `Class ${classes[i]} (${Math.round(scores[i] * 100)}%)`,
                            x * video.videoWidth,
                            y * video.videoHeight > 10 ? y * video.videoHeight - 5 : 10
                        );
                    }
                }

                requestAnimationFrame(detectFrame);
            }

            detectFrame();
        }

        detectObjects();
    </script>

</body>
</html>
